<% content_for :title, "Books" %>

<div class="d-flex justify-content-between align-items-center mb-4">
  <h1 class="fw-bold">ðŸ“š Books</h1>

  <div>
    <% if user_signed_in? &&  current_user.admin? %>
      <%= link_to "â¬‡ Export to CSV",
                  books_path(format: :csv),
                  class: "btn btn-success me-2" %>
    <% end %>

    <% if user_signed_in? && (current_user.writer? || current_user.admin?) %>
      <%= link_to "âž• New Book", new_book_path, class: "btn btn-primary" %>
    <% end %>
  </div>

</div>

<div class="card mb-3">
  <div class="card-body">
    <%= form_with url: books_path, method: :get, local: true, class: "row g-2 align-items-end" do |f| %>
      <div class="col-md-5">
        <%= f.label :search, "Search (Title or ISBN)" %>
        <%= f.text_field :search, value: params[:search], class: "form-control", placeholder: "Enter title or ISBN" %>
      </div>

      <div class="col-md-3">
        <%= f.label :author_id, "Author" %>
        <%= f.select :author_id, options_for_select([["All authors", ""]] + @authors.map { |a| [a.name, a.id] }, params[:author_id]), {}, class: "form-select" %>
      </div>

      <div class="col-md-3">
        <%= f.label :category_id, "Category" %>
        <%= f.select :category_id, options_for_select([["All categories", ""]] + @categories.map { |c| [c.name, c.id] }, params[:category_id]), {}, class: "form-select" %>
      </div>

      <div class="col-md-1 d-grid">
        <%= f.submit "Filter", class: "btn btn-primary" %>
      </div>
    <% end %>

    <div class="mt-2">
      <% if params[:search].present? || params[:author_id].present? || params[:category_id].present? %>
        <%= link_to "Clear filters", books_path, class: "btn btn-sm btn-outline-secondary" %>
      <% end %>
    </div>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-body p-0">
    <table class="table table-hover mb-0">
      <thead class="table-dark">
      <tr>
        <th>Title</th>
        <th>ISBN</th>
        <th>Author</th>
        <th>Category</th>
        <th>Tags</th>
        <th>Comments</th>
        <th style="width: 200px;">Actions</th>
      </tr>
      </thead>

      <tbody>
      <% @books.each do |book| %>
        <tr>
          <td class="fw-semibold">
            <%= link_to book.title, book_path(book), class: "text-decoration-none" %>
          </td>
          <td><%= book.isbn %></td>
          <td>
            <% if book.author %>
              <%= link_to book.author.name, author_path(book.author), class: "text-decoration-none" %>
            <% else %>
              <span class="text-muted">â€”</span>
            <% end %>
          </td>
          <td><%= book.category&.name || "-" %></td>
          <td>
            <% if book.tags.any? %>
              <%= book.tags.map { |t| content_tag(:span, t.name, class: "badge bg-secondary me-1") }.join.html_safe %>
            <% else %>
              <span class="text-muted">No tags</span>
            <% end %>
          </td>
          <td><%= book.comments_count %></td>
          <td>
            <%= link_to "Show", book_path(book), class: "btn btn-sm btn-outline-primary me-2" %>

            <% if user_signed_in? && (current_user.writer? || current_user.admin?) %>
              <%= link_to "Edit", edit_book_path(book), class: "btn btn-sm btn-warning me-2" %>
            <% end %>

            <% if user_signed_in? && current_user.admin? %>
              <%= link_to "Delete", book_path(book),
                          data: { turbo_method: :delete, turbo_confirm: "Are you sure?" },
                          class: "btn btn-sm btn-danger" %>
            <% end %>
          </td>
        </tr>
      <% end %>
      </tbody>
    </table>
  </div>
</div>


<div class="mt-3 d-flex justify-content-center">
  <%= will_paginate @books %>
</div>